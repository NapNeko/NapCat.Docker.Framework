name: docker-publish

on:
  workflow_dispatch:

jobs:
  get-tag:
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Get latest tag
        id: get-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/repos/NapNeko/NapCatQQ/releases/latest" | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build-amd64:
    needs: get-tag
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download NapCat.Framework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.get-tag.outputs.tag }}
          echo "Downloading NapCat.Framework.zip for tag ${TAG}"
          curl -fL -H "Authorization: token ${GITHUB_TOKEN}" -o NapCat.Framework.zip "https://github.com/NapNeko/NapCatQQ/releases/download/${TAG}/NapCat.Framework.zip"
          ls -la NapCat.Framework.zip
      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push amd64 image
        env:
          DOCKER_REPO: mlikiowa/napcat-framework-docker
          TAG: ${{ needs.get-tag.outputs.tag }}
        run: |
          docker buildx build \
            --load \
            --platform linux/amd64 \
            --tag ${DOCKER_REPO}:${TAG}-amd64 \
            --tag ${DOCKER_REPO}:latest-amd64 \
            --file ./Dockerfile \
            .
          docker push ${DOCKER_REPO}:${TAG}-amd64
          docker push ${DOCKER_REPO}:latest-amd64
      - name: Docker Hub logout
        if: always()
        run: docker logout

  build-arm64:
    needs: get-tag
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download NapCat.Framework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.get-tag.outputs.tag }}
          echo "Downloading NapCat.Framework.zip for tag ${TAG}"
          curl -fL -H "Authorization: token ${GITHUB_TOKEN}" -o NapCat.Framework.zip "https://github.com/NapNeko/NapCatQQ/releases/download/${TAG}/NapCat.Framework.zip"
          ls -la NapCat.Framework.zip
      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push arm64 image
        env:
          DOCKER_REPO: mlikiowa/napcat-framework-docker
          TAG: ${{ needs.get-tag.outputs.tag }}
        run: |
          docker buildx build \
            --load \
            --platform linux/arm64 \
            --tag ${DOCKER_REPO}:${TAG}-arm64 \
            --tag ${DOCKER_REPO}:latest-arm64 \
            --file ./Dockerfile \
            .
          docker push ${DOCKER_REPO}:${TAG}-arm64
          docker push ${DOCKER_REPO}:latest-arm64
      - name: Docker Hub logout
        if: always()
        run: docker logout

  create-manifest:
    needs: [get-tag, build-amd64, build-arm64]
    runs-on: ubuntu-22.04
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Create and push multi-arch manifest
        env:
          DOCKER_REPO: mlikiowa/napcat-framework-docker
          TAG: ${{ needs.get-tag.outputs.tag }}
        run: |
          # Create and push tagged manifest
          docker manifest create ${DOCKER_REPO}:${TAG} \
            ${DOCKER_REPO}:${TAG}-amd64 \
            ${DOCKER_REPO}:${TAG}-arm64
          docker manifest push ${DOCKER_REPO}:${TAG}
          
          # Create and push latest manifest
          docker manifest create ${DOCKER_REPO}:latest \
            ${DOCKER_REPO}:latest-amd64 \
            ${DOCKER_REPO}:latest-arm64
          docker manifest push ${DOCKER_REPO}:latest
      - name: Docker Hub logout
        if: always()
        run: docker logout
